cat > /root/main.py << 'EOF'
# -*- coding: utf-8 -*-

import re
from typing import Optional

import cv2
import numpy as np
import easyocr
from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import JSONResponse

app = FastAPI(title="Plate OCR API", version="1.0.0")

reader = easyocr.Reader(["pt", "en"], gpu=False)

PLATE_PATTERNS = [
    re.compile(r"^[A-Z]{3}\d{4}$"),
    re.compile(r"^[A-Z]{3}\d[A-Z]\d{2}$"),
]

def normalize_text(text: str) -> str:
    text = (text or "").upper()
    text = re.sub(r"[^A-Z0-9]", "", text)
    return text

def looks_like_plate(text: str) -> bool:
    return any(p.match(text) for p in PLATE_PATTERNS)

def fix_mercosul(text: str) -> str:
    if len(text) != 7:
        return text

    chars = list(text)

    for i in (3, 5, 6):
        if chars[i] == "O":
            chars[i] = "0"
        elif chars[i] == "I":
            chars[i] = "1"
        elif chars[i] == "S":
            chars[i] = "5"

    if chars[4] == "0":
        chars[4] = "O"
    elif chars[4] == "1":
        chars[4] = "I"
    elif chars[4] == "5":
        chars[4] = "S"

    return "".join(chars)

def preprocess_for_ocr(img: np.ndarray) -> np.ndarray:
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    gray = cv2.bilateralFilter(gray, 9, 75, 75)

    clahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))
    gray = clahe.apply(gray)

    return cv2.adaptiveThreshold(
        gray,
        255,
        cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv2.THRESH_BINARY,
        31,
        5,
    )

def extract_best_plate(img: np.ndarray) -> Optional[str]:
    results = reader.readtext(img, detail=1, paragraph=False)

    best_plate = None
    best_score = -1.0

    for _, text, conf in results:
        raw = normalize_text(str(text))
        fixed = fix_mercosul(raw)
        score = float(conf)

        if looks_like_plate(fixed):
            score += 0.3

        if len(fixed) < 6:
            continue

        if score > best_score:
            best_score = score
            best_plate = fixed

    if best_plate and looks_like_plate(best_plate):
        return best_plate

    if best_plate and len(best_plate) == 7 and best_score >= 0.5:
        return best_plate

    return None

@app.get("/health")
def health():
    return {"status": "ok"}

@app.post("/read-plate")
async def read_plate(file: UploadFile = File(...)):
    if not file.content_type or not file.content_type.startswith("image/"):
        raise HTTPException(status_code=400, detail="File must be an image")

    data = await file.read()
    if not data:
        raise HTTPException(status_code=400, detail="Empty file")

    buf = np.frombuffer(data, dtype=np.uint8)
    img = cv2.imdecode(buf, cv2.IMREAD_COLOR)
    if img is None:
        raise HTTPException(status_code=400, detail="Invalid image")

    plate = extract_best_plate(img)
    if plate:
        return JSONResponse(content=plate)

    pre = preprocess_for_ocr(img)
    plate2 = extract_best_plate(pre)

    return JSONResponse(content=plate2)
EOF
